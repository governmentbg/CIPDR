import{D as DEFAULT_STATE_TYPE,a as DIVIDER_TYPE,S as STMT_RELATION,b as STMT_STATE,c as DEFAULT_NESTED_DOC_DIR,p as parser,d as db,s as styles}from"./styles-91b2881f.js";import{G as Graph}from"./layout-7899ed33.js";import{l as log,c as getConfig,j as d3select,A as utils,k as configureSvgSize,f as common}from"./mermaid-f185fde2.js";import{r as render}from"./index-1bb7dfb9.js";import"./edges-ecd2ecb8.js";import"./createText-6836bc4a.js";import"./svgDraw-092a0897.js";import"./line-eb9172ee.js";import"./array-b7dcf730.js";import"./constant-b644328d.js";const SHAPE_STATE="rect",SHAPE_STATE_WITH_DESC="rectWithTitle",SHAPE_START="start",SHAPE_END="end",SHAPE_DIVIDER="divider",SHAPE_GROUP="roundedWithTitle",SHAPE_NOTE="note",SHAPE_NOTEGROUP="noteGroup",CSS_DIAGRAM="statediagram",CSS_STATE="state",CSS_DIAGRAM_STATE=CSS_DIAGRAM+"-"+CSS_STATE,CSS_EDGE="transition",CSS_NOTE="note",CSS_NOTE_EDGE="note-edge",CSS_EDGE_NOTE_EDGE=CSS_EDGE+" "+CSS_NOTE_EDGE,CSS_DIAGRAM_NOTE=CSS_DIAGRAM+"-"+CSS_NOTE,CSS_CLUSTER="cluster",CSS_DIAGRAM_CLUSTER=CSS_DIAGRAM+"-"+CSS_CLUSTER,CSS_CLUSTER_ALT="cluster-alt",CSS_DIAGRAM_CLUSTER_ALT=CSS_DIAGRAM+"-"+CSS_CLUSTER_ALT,PARENT="parent",NOTE="note",DOMID_STATE="state",DOMID_TYPE_SPACER="----",NOTE_ID=""+DOMID_TYPE_SPACER+NOTE,PARENT_ID=""+DOMID_TYPE_SPACER+PARENT,G_EDGE_STYLE="fill:none",G_EDGE_ARROWHEADSTYLE="fill: #333",G_EDGE_LABELPOS="c",G_EDGE_LABELTYPE="text",G_EDGE_THICKNESS="normal";let nodeDb={},graphItemCount=0;const setConf=function(e){for(const t of Object.keys(e))e[t]},getClasses=function(e,t){return t.db.extract(t.db.getRootDocV2()),t.db.getClasses()};function getClassesFromDbInfo(e){return null!=e&&e.classes?e.classes.join(" "):""}function stateDomId(e="",t=0,s="",o=DOMID_TYPE_SPACER){o=null!==s&&0<s.length?""+o+s:"";return DOMID_STATE+`-${e}${o}-`+t}const setupNode=(s,e,o,t,r,a)=>{var E=o.id,i=getClassesFromDbInfo(t[E]);if("root"!==E){let e=SHAPE_STATE;!0===o.start&&(e=SHAPE_START),!1===o.start&&(e=SHAPE_END),o.type!==DEFAULT_STATE_TYPE&&(e=o.type),nodeDb[E]||(nodeDb[E]={id:E,shape:e,description:common.sanitizeText(E,getConfig()),classes:i+" "+CSS_DIAGRAM_STATE});const S=nodeDb[E],_=(o.description&&(Array.isArray(S.description)?(S.shape=SHAPE_STATE_WITH_DESC,S.description.push(o.description)):0<S.description.length?(S.shape=SHAPE_STATE_WITH_DESC,S.description===E?S.description=[o.description]:S.description=[S.description,o.description]):(S.shape=SHAPE_STATE,S.description=o.description),S.description=common.sanitizeTextOrArray(S.description,getConfig())),1===S.description.length&&S.shape===SHAPE_STATE_WITH_DESC&&(S.shape=SHAPE_STATE),!S.type&&o.doc&&(log.info("Setting cluster for ",E,getDir(o)),S.type="group",S.dir=getDir(o),S.shape=o.type===DIVIDER_TYPE?SHAPE_DIVIDER:SHAPE_GROUP,S.classes=S.classes+" "+CSS_DIAGRAM_CLUSTER+" "+(a?CSS_DIAGRAM_CLUSTER_ALT:"")),{labelStyle:"",shape:S.shape,labelText:S.description,classes:S.classes,style:"",id:E,dir:S.dir,domId:stateDomId(E,graphItemCount),type:S.type,padding:15});if(_.centerLabel=!0,o.note){var i={labelStyle:"",shape:SHAPE_NOTE,labelText:o.note.text,classes:CSS_DIAGRAM_NOTE,style:"",id:E+NOTE_ID+"-"+graphItemCount,domId:stateDomId(E,graphItemCount,NOTE),type:S.type,padding:15},n={labelStyle:"",shape:SHAPE_NOTEGROUP,labelText:o.note.text,classes:S.classes,style:"",id:E+PARENT_ID,domId:stateDomId(E,graphItemCount,PARENT),type:"group",padding:0},d=(graphItemCount++,E+PARENT_ID);s.setNode(d,n),s.setNode(i.id,i),s.setNode(E,_),s.setParent(E,d),s.setParent(i.id,d);let e=E,t=i.id;"left of"===o.note.position&&(e=i.id,t=E),s.setEdge(e,t,{arrowhead:"none",arrowType:"",style:G_EDGE_STYLE,labelStyle:"",classes:CSS_EDGE_NOTE_EDGE,arrowheadStyle:G_EDGE_ARROWHEADSTYLE,labelpos:G_EDGE_LABELPOS,labelType:G_EDGE_LABELTYPE,thickness:G_EDGE_THICKNESS})}else s.setNode(E,_)}e&&"root"!==e.id&&(log.trace("Setting node ",E," to be child of its parent ",e.id),s.setParent(E,e.id)),o.doc&&(log.trace("Adding nodes children "),setupDoc(s,o,o.doc,t,r,!a))},setupDoc=(s,o,e,r,a,E)=>{log.trace("items",e),e.forEach(e=>{switch(e.stmt){case STMT_STATE:case DEFAULT_STATE_TYPE:setupNode(s,o,e,r,a,E);break;case STMT_RELATION:setupNode(s,o,e.state1,r,a,E),setupNode(s,o,e.state2,r,a,E);var t={id:"edge"+graphItemCount,arrowhead:"normal",arrowTypeEnd:"arrow_barb",style:G_EDGE_STYLE,labelStyle:"",label:common.sanitizeText(e.description,getConfig()),arrowheadStyle:G_EDGE_ARROWHEADSTYLE,labelpos:G_EDGE_LABELPOS,labelType:G_EDGE_LABELTYPE,thickness:G_EDGE_THICKNESS,classes:CSS_EDGE};s.setEdge(e.state1.id,e.state2.id,t,graphItemCount),graphItemCount++}})},getDir=(t,e=DEFAULT_NESTED_DOC_DIR)=>{let s=e;if(t.doc)for(let e=0;e<t.doc.length;e++){var o=t.doc[e];"dir"===o.stmt&&(s=o.value)}return s},draw=async function(e,t,s,o){log.info("Drawing state diagram (v2)",t),nodeDb={},o.db.getDirection();var{securityLevel:r,state:a}=getConfig(),E=a.nodeSpacing||50,i=a.rankSpacing||50,n=(log.info(o.db.getRootDocV2()),o.db.extract(o.db.getRootDocV2()),log.info(o.db.getRootDocV2()),o.db.getStates()),E=new Graph({multigraph:!0,compound:!0}).setGraph({rankdir:getDir(o.db.getRootDocV2()),nodesep:E,ranksep:i,marginx:8,marginy:8}).setDefaultEdgeLabel(function(){return{}});setupNode(E,void 0,o.db.getRootDocV2(),n,o.db,!0);let d;"sandbox"===r&&(d=d3select("#i"+t));const S=d3select("sandbox"===r?d.nodes()[0].contentDocument.body:"body"),_=S.select(`[id="${t}"]`);i=S.select("#"+t+" g"),await render(i,E,["barb"],CSS_DIAGRAM,t),utils.insertTitle(_,"statediagramTitleText",a.titleTopMargin,o.db.getDiagramTitle()),n=_.node().getBBox(),r=n.width+16,i=n.height+16,_.attr("class",CSS_DIAGRAM),E=_.node().getBBox(),configureSvgSize(_,i,r,a.useMaxWidth),o=`${E.x-8} ${E.y-8} ${r} `+i,log.debug("viewBox "+o),_.attr("viewBox",o),n=document.querySelectorAll('[id="'+t+'"] .edgeLabel .label');for(const l of n){var T=l.getBBox();const A=document.createElementNS("http://www.w3.org/2000/svg",SHAPE_STATE);A.setAttribute("rx",0),A.setAttribute("ry",0),A.setAttribute("width",T.width),A.setAttribute("height",T.height),l.insertBefore(A,l.firstChild)}},renderer={setConf:setConf,getClasses:getClasses,draw:draw},diagram={parser:parser,db:db,renderer:renderer,styles:styles,init:e=>{e.state||(e.state={}),e.state.arrowMarkerAbsolute=e.arrowMarkerAbsolute,db.clear()}};export{diagram};