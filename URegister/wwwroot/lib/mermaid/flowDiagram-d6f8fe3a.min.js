import{p as parser,f as flowDb}from"./flowDb-ff651a22.js";import*as graphlib from"dagre-d3-es/src/graphlib/index.js";import{select,curveLinear,selectAll}from"d3";import{k as getStylesFromArray,n as evaluate,c as getConfig,e as common,l as log,o as interpolateToCurve,p as setupGraphViewbox}from"./mermaid-768dc893.js";import{render}from"dagre-d3-es";import{applyStyle}from"dagre-d3-es/src/dagre-js/util.js";import{addHtmlLabel}from"dagre-d3-es/src/dagre-js/label/add-html-label.js";import{intersectPolygon}from"dagre-d3-es/src/dagre-js/intersect/intersect-polygon.js";import{intersectRect}from"dagre-d3-es/src/dagre-js/intersect/intersect-rect.js";import{f as flowRendererV2,a as flowStyles}from"./styles-1b0c237a.js";import"ts-dedent";import"dayjs";import"@braintree/sanitize-url";import"dompurify";import"khroma";import"lodash-es/memoize.js";import"lodash-es/merge.js";import"stylis";import"lodash-es/isEmpty.js";import"./index-f58d48f9.js";import"dagre-d3-es/src/dagre/index.js";import"dagre-d3-es/src/graphlib/json.js";import"./edges-0005682e.js";import"./createText-3b1f58a4.js";import"mdast-util-from-markdown";import"./svgDraw-70101091.js";function question(e,t,r){t=.9*(t.width+t.height);const a=[{x:t/2,y:0},{x:t,y:-t/2},{x:t/2,y:-t},{x:0,y:-t/2}];e=insertPolygonShape(e,t,t,a);return r.intersect=function(e){return intersectPolygon(r,a,e)},e}function hexagon(e,t,r){var a=t.height,o=a/4,t=t.width+2*o;const n=[{x:o,y:0},{x:t-o,y:0},{x:t,y:-a/2},{x:t-o,y:-a},{x:o,y:-a},{x:0,y:-a/2}];o=insertPolygonShape(e,t,a,n);return r.intersect=function(e){return intersectPolygon(r,n,e)},o}function rect_left_inv_arrow(e,t,r){var a=t.width,t=t.height;const o=[{x:-t/2,y:0},{x:a,y:0},{x:a,y:-t},{x:-t/2,y:-t},{x:0,y:-t/2}];e=insertPolygonShape(e,a,t,o);return r.intersect=function(e){return intersectPolygon(r,o,e)},e}function lean_right(e,t,r){var a=t.width,t=t.height;const o=[{x:-2*t/6,y:0},{x:a-t/6,y:0},{x:a+2*t/6,y:-t},{x:t/6,y:-t}];e=insertPolygonShape(e,a,t,o);return r.intersect=function(e){return intersectPolygon(r,o,e)},e}function lean_left(e,t,r){var a=t.width,t=t.height;const o=[{x:2*t/6,y:0},{x:a+t/6,y:0},{x:a-2*t/6,y:-t},{x:-t/6,y:-t}];e=insertPolygonShape(e,a,t,o);return r.intersect=function(e){return intersectPolygon(r,o,e)},e}function trapezoid(e,t,r){var a=t.width,t=t.height;const o=[{x:-2*t/6,y:0},{x:a+2*t/6,y:0},{x:a-t/6,y:-t},{x:t/6,y:-t}];e=insertPolygonShape(e,a,t,o);return r.intersect=function(e){return intersectPolygon(r,o,e)},e}function inv_trapezoid(e,t,r){var a=t.width,t=t.height;const o=[{x:t/6,y:0},{x:a-t/6,y:0},{x:a+2*t/6,y:-t},{x:-2*t/6,y:-t}];e=insertPolygonShape(e,a,t,o);return r.intersect=function(e){return intersectPolygon(r,o,e)},e}function rect_right_inv_arrow(e,t,r){var a=t.width,t=t.height;const o=[{x:0,y:0},{x:a+t/2,y:0},{x:a,y:-t/2},{x:a+t/2,y:-t},{x:0,y:-t}];e=insertPolygonShape(e,a,t,o);return r.intersect=function(e){return intersectPolygon(r,o,e)},e}function stadium(e,t,r){var a=t.height,t=t.width+a/4,e=e.insert("rect",":first-child").attr("rx",a/2).attr("ry",a/2).attr("x",-t/2).attr("y",-a/2).attr("width",t).attr("height",a);return r.intersect=function(e){return intersectRect(r,e)},e}function subroutine(e,t,r){var a=t.width,t=t.height;const o=[{x:0,y:0},{x:a,y:0},{x:a,y:-t},{x:0,y:-t},{x:0,y:0},{x:-8,y:0},{x:a+8,y:0},{x:a+8,y:-t},{x:-8,y:-t},{x:-8,y:0}];e=insertPolygonShape(e,a,t,o);return r.intersect=function(e){return intersectPolygon(r,o,e)},e}function cylinder(e,t,o){var r=t.width;const n=r/2,s=n/(2.5+r/50);var t=t.height+s,a="M 0,"+s+" a "+n+","+s+" 0,0,0 "+r+" 0 a "+n+","+s+" 0,0,0 "+-r+" 0 l 0,"+t+" a "+n+","+s+" 0,0,0 "+r+" 0 l 0,"+-t,e=e.attr("label-offset-y",s).insert("path",":first-child").attr("d",a).attr("transform","translate("+-r/2+","+-(t/2+s)+")");return o.intersect=function(t){const r=intersectRect(o,t);var a=r.x-o.x;if(0!=n&&(Math.abs(a)<o.width/2||Math.abs(a)==o.width/2&&Math.abs(r.y-o.y)>o.height/2-s)){let e=s*s*(1-a*a/(n*n));0!=e&&(e=Math.sqrt(e)),e=s-e,0<t.y-o.y&&(e=-e),r.y+=e}return r},e}function addToRender(e){e.shapes().question=question,e.shapes().hexagon=hexagon,e.shapes().stadium=stadium,e.shapes().subroutine=subroutine,e.shapes().cylinder=cylinder,e.shapes().rect_left_inv_arrow=rect_left_inv_arrow,e.shapes().lean_right=lean_right,e.shapes().lean_left=lean_left,e.shapes().trapezoid=trapezoid,e.shapes().inv_trapezoid=inv_trapezoid,e.shapes().rect_right_inv_arrow=rect_right_inv_arrow}function addToRenderV2(e){e({question:question}),e({hexagon:hexagon}),e({stadium:stadium}),e({subroutine:subroutine}),e({cylinder:cylinder}),e({rect_left_inv_arrow:rect_left_inv_arrow}),e({lean_right:lean_right}),e({lean_left:lean_left}),e({trapezoid:trapezoid}),e({inv_trapezoid:inv_trapezoid}),e({rect_right_inv_arrow:rect_right_inv_arrow})}function insertPolygonShape(e,t,r,a){return e.insert("polygon",":first-child").attr("points",a.map(function(e){return e.x+","+e.y}).join(" ")).attr("transform","translate("+-t/2+","+r/2+")")}const flowChartShapes={addToRender:addToRender,addToRenderV2:addToRenderV2},conf={},setConf=function(e){for(const t of Object.keys(e))conf[t]=e[t]},addVertices=function(h,p,e,t,r,g){const f=t?t.select(`[id="${e}"]`):select(`[id="${e}"]`),u=r||document,a=Object.keys(h);a.forEach(function(e){const t=h[e];let r="default";0<t.classes.length&&(r=t.classes.join(" "));const a=getStylesFromArray(t.styles);let o=void 0!==t.text?t.text:t.id,n;if(evaluate(getConfig().flowchart.htmlLabels)){e={label:o.replace(/fa[blrs]?:fa-[\w-]+/g,e=>`<i class='${e.replace(":"," ")}'></i>`)};(n=addHtmlLabel(f,e).node()).parentNode.removeChild(n)}else{const l=u.createElementNS("http://www.w3.org/2000/svg","text");l.setAttribute("style",a.labelStyle.replace("color:","fill:"));for(const d of o.split(common.lineBreakRegex)){const c=u.createElementNS("http://www.w3.org/2000/svg","tspan");c.setAttributeNS("http://www.w3.org/XML/1998/namespace","xml:space","preserve"),c.setAttribute("dy","1em"),c.setAttribute("x","1"),c.textContent=d,l.appendChild(c)}n=l}let s=0,i="";switch(t.type){case"round":s=5,i="rect";break;case"square":i="rect";break;case"diamond":i="question";break;case"hexagon":i="hexagon";break;case"odd":i="rect_left_inv_arrow";break;case"lean_right":i="lean_right";break;case"lean_left":i="lean_left";break;case"trapezoid":i="trapezoid";break;case"inv_trapezoid":i="inv_trapezoid";break;case"odd_right":i="rect_left_inv_arrow";break;case"circle":i="circle";break;case"ellipse":i="ellipse";break;case"stadium":i="stadium";break;case"subroutine":i="subroutine";break;case"cylinder":i="cylinder";break;default:i="rect"}log.warn("Adding node",t.id,t.domId),p.setNode(g.db.lookUpDomId(t.id),{labelType:"svg",labelStyle:a.labelStyle,shape:i,label:n,rx:s,ry:s,class:r,style:a.style,id:g.db.lookUpDomId(t.id)})})},addEdges=function(l,d,c){let h=0,p,g;var e;void 0!==l.defaultStyle&&(e=getStylesFromArray(l.defaultStyle),p=e.style,g=e.labelStyle),l.forEach(function(e){h++;var t="L-"+e.start+"-"+e.end,r="LS-"+e.start,a="LE-"+e.end;const o={};"arrow_open"===e.type?o.arrowhead="none":o.arrowhead="normal";let n="",s="";if(void 0!==e.style){var i=getStylesFromArray(e.style);n=i.style,s=i.labelStyle}else switch(e.stroke){case"normal":n="fill:none",void 0!==p&&(n=p),void 0!==g&&(s=g);break;case"dotted":n="fill:none;stroke-width:2px;stroke-dasharray:3;";break;case"thick":n=" stroke-width: 3.5px;fill:none"}o.style=n,o.labelStyle=s,void 0!==e.interpolate?o.curve=interpolateToCurve(e.interpolate,curveLinear):void 0!==l.defaultInterpolate?o.curve=interpolateToCurve(l.defaultInterpolate,curveLinear):o.curve=interpolateToCurve(conf.curve,curveLinear),void 0===e.text?void 0!==e.style&&(o.arrowheadStyle="fill: #333"):(o.arrowheadStyle="fill: #333",o.labelpos="c",evaluate(getConfig().flowchart.htmlLabels)?(o.labelType="html",o.label=`<span id="L-${t}" class="edgeLabel L-${r}' L-${a}" style="${o.labelStyle}">${e.text.replace(/fa[blrs]?:fa-[\w-]+/g,e=>`<i class='${e.replace(":"," ")}'></i>`)}</span>`):(o.labelType="text",o.label=e.text.replace(common.lineBreakRegex,"\n"),void 0===e.style&&(o.style=o.style||"stroke: #333; stroke-width: 1.5px;fill:none"),o.labelStyle=o.labelStyle.replace("color:","fill:"))),o.id=t,o.class=r+" "+a,o.minlen=e.length||1,d.setEdge(c.db.lookUpDomId(e.start),c.db.lookUpDomId(e.end),o,h)})},getClasses=function(e,t){return log.info("Extracting classes"),t.db.getClasses()},draw=function(e,i,t,l){log.info("Drawing flowchart");const{securityLevel:d,flowchart:r}=getConfig();let a;"sandbox"===d&&(a=select("#i"+i));const c="sandbox"===d?select(a.nodes()[0].contentDocument.body):select("body"),h="sandbox"===d?a.nodes()[0].contentDocument:document;let o=l.db.getDirection();void 0===o&&(o="TD");var n=r.nodeSpacing||50,s=r.rankSpacing||50;const p=new graphlib.Graph({multigraph:!0,compound:!0}).setGraph({rankdir:o,nodesep:n,ranksep:s,marginx:8,marginy:8}).setDefaultEdgeLabel(function(){return{}});let g;var f=l.db.getSubGraphs();for(let e=f.length-1;0<=e;e--)g=f[e],l.db.addVertex(g.id,g.title,"group",void 0,g.classes);const u=l.db.getVertices();log.warn("Get vertices",u);n=l.db.getEdges();let y=0;for(y=f.length-1;0<=y;y--){g=f[y],selectAll("cluster").append("text");for(let e=0;e<g.nodes.length;e++)log.warn("Setting subgraph",g.nodes[e],l.db.lookUpDomId(g.nodes[e]),l.db.lookUpDomId(g.id)),p.setParent(l.db.lookUpDomId(g.nodes[e]),l.db.lookUpDomId(g.id))}addVertices(u,p,i,c,h,l),addEdges(n,p,l);const b=new render;flowChartShapes.addToRender(b),b.arrows().none=function(e,t,r,a){const o=e.append("marker").attr("id",t).attr("viewBox","0 0 10 10").attr("refX",9).attr("refY",5).attr("markerUnits","strokeWidth").attr("markerWidth",8).attr("markerHeight",6).attr("orient","auto");e=o.append("path").attr("d","M 0 0 L 0 0 L 0 0 z");applyStyle(e,r[a+"Style"])},b.arrows().normal=function(e,t){const r=e.append("marker").attr("id",t).attr("viewBox","0 0 10 10").attr("refX",9).attr("refY",5).attr("markerUnits","strokeWidth").attr("markerWidth",8).attr("markerHeight",6).attr("orient","auto");r.append("path").attr("d","M 0 0 L 10 5 L 0 10 z").attr("class","arrowheadPath").style("stroke-width",1).style("stroke-dasharray","1,0")};s=c.select(`[id="${i}"]`);const w=c.select("#"+i+" g");for(b(w,p),w.selectAll("g.node").attr("title",function(){return l.db.getTooltip(this.id)}),l.db.indexNodes("subGraph"+y),y=0;y<f.length;y++)if("undefined"!==(g=f[y]).title){var m=h.querySelectorAll("#"+i+' [id="'+l.db.lookUpDomId(g.id)+'"] rect');const S=h.querySelectorAll("#"+i+' [id="'+l.db.lookUpDomId(g.id)+'"]');var x=m[0].x.baseVal.value,v=m[0].y.baseVal.value,m=m[0].width.baseVal.value;const j=select(S[0]),A=j.select(".label");A.attr("transform",`translate(${x+m/2}, ${v+14})`),A.attr("id",i+"Text");for(let e=0;e<g.classes.length;e++)S[0].classList.add(g.classes[e])}if(!r.htmlLabels)for(const L of h.querySelectorAll('[id="'+i+'"] .edgeLabel .label')){var k=L.getBBox();const D=h.createElementNS("http://www.w3.org/2000/svg","rect");D.setAttribute("rx",0),D.setAttribute("ry",0),D.setAttribute("width",k.width),D.setAttribute("height",k.height),L.insertBefore(D,L.firstChild)}setupGraphViewbox(p,s,r.diagramPadding,r.useMaxWidth);const _=Object.keys(u);_.forEach(function(e){const t=u[e];if(t.link){const r=c.select("#"+i+' [id="'+l.db.lookUpDomId(e)+'"]');if(r){const a=h.createElementNS("http://www.w3.org/2000/svg","a"),o=(a.setAttributeNS("http://www.w3.org/2000/svg","class",t.classes.join(" ")),a.setAttributeNS("http://www.w3.org/2000/svg","href",t.link),a.setAttributeNS("http://www.w3.org/2000/svg","rel","noopener"),"sandbox"===d?a.setAttributeNS("http://www.w3.org/2000/svg","target","_top"):t.linkTarget&&a.setAttributeNS("http://www.w3.org/2000/svg","target",t.linkTarget),r.insert(function(){return a},":first-child")),n=r.select(".label-container"),s=(n&&o.append(function(){return n.node()}),r.select(".label"));s&&o.append(function(){return s.node()})}}})},flowRenderer={setConf:setConf,addVertices:addVertices,addEdges:addEdges,getClasses:getClasses,draw:draw},diagram={parser:parser,db:flowDb,renderer:flowRendererV2,styles:flowStyles,init:e=>{e.flowchart||(e.flowchart={}),e.flowchart.arrowMarkerAbsolute=e.arrowMarkerAbsolute,flowRenderer.setConf(e.flowchart),flowDb.clear(),flowDb.setGen("gen-1")}};export{diagram};