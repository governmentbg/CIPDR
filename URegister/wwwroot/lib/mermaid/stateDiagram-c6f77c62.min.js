import{d as N,p as C,s as R}from"./styles-91bd061f.js";import{c as t,G as U,A as F,f as T,l as b,j as H,k as O}from"./mermaid-d733041c.js";import{G as X,l as J}from"./layout-df07420e.js";import{l as Y}from"./line-b0ce4b23.js";import"./array-2ff2c7a6.js";import"./constant-2fe7eae5.js";const L={},$=(t,e)=>{L[t]=e},v=t=>L[t],P=()=>Object.keys(L),I=()=>P().length,_={get:v,set:$,keys:P,size:I},j=e=>e.append("circle").attr("class","start-state").attr("r",t().state.sizeUnit).attr("cx",t().state.padding+t().state.sizeUnit).attr("cy",t().state.padding+t().state.sizeUnit),q=e=>e.append("line").style("stroke","grey").style("stroke-dasharray","3").attr("x1",t().state.textHeight).attr("class","divider").attr("x2",2*t().state.textHeight).attr("y1",0).attr("y2",0),Z=(e,a)=>{const i=e.append("text").attr("x",2*t().state.padding).attr("y",t().state.textHeight+2*t().state.padding).attr("font-size",t().state.fontSize).attr("class","state-title").text(a.id),r=i.node().getBBox();return e.insert("rect",":first-child").attr("x",t().state.padding).attr("y",t().state.padding).attr("width",r.width+2*t().state.padding).attr("height",r.height+2*t().state.padding).attr("rx",t().state.radius),i},K=(e,a)=>{const i=e.append("text").attr("x",2*t().state.padding).attr("y",t().state.textHeight+1.3*t().state.padding).attr("font-size",t().state.fontSize).attr("class","state-title").text(a.descriptions[0]).node().getBBox(),r=i.height,n=e.append("text").attr("x",t().state.padding).attr("y",r+.4*t().state.padding+t().state.dividerMargin+t().state.textHeight).attr("class","state-description");let d=!0,s=!0;a.descriptions.forEach(function(e){if(!d){{var a=n,i=s;const r=a.append("tspan").attr("x",2*t().state.padding).text(e);i||r.attr("dy",t().state.textHeight)}s=!1}d=!1});const o=e.append("line").attr("x1",t().state.padding).attr("y1",t().state.padding+r+t().state.dividerMargin/2).attr("y2",t().state.padding+r+t().state.dividerMargin/2).attr("class","descr-divider"),g=n.node().getBBox(),p=Math.max(g.width,i.width);return o.attr("x2",p+3*t().state.padding),e.insert("rect",":first-child").attr("x",t().state.padding).attr("y",t().state.padding).attr("width",p+2*t().state.padding).attr("height",g.height+r+2*t().state.padding).attr("rx",t().state.radius),e},Q=(e,a,i)=>{const r=t().state.padding,n=2*t().state.padding,d=e.node().getBBox(),s=d.width,o=d.x,g=e.append("text").attr("x",0).attr("y",t().state.titleShift).attr("font-size",t().state.fontSize).attr("class","state-title").text(a.id),p=g.node().getBBox().width+n;let h=Math.max(p,s);h===s&&(h+=n);let c;var l=e.node().getBBox(),a=(a.doc,c=o-r,s<p&&(c=(s-h)/2+r),Math.abs(o-l.x)<r&&s<p&&(c=o-(p-s)/2),1-t().state.textHeight);return e.insert("rect",":first-child").attr("x",c).attr("y",a).attr("class",i?"alt-composit":"composit").attr("width",h).attr("height",l.height+t().state.textHeight+t().state.titleShift+1).attr("rx","0"),g.attr("x",c+r),p<=s&&g.attr("x",o+(h-n)/2-p/2+r),e.insert("rect",":first-child").attr("x",c).attr("y",t().state.titleShift-t().state.textHeight-t().state.padding).attr("width",h).attr("height",3*t().state.textHeight).attr("rx",t().state.radius),e.insert("rect",":first-child").attr("x",c).attr("y",t().state.titleShift-t().state.textHeight-t().state.padding).attr("width",h).attr("height",l.height+3+2*t().state.textHeight).attr("rx",t().state.radius),e},V=e=>(e.append("circle").attr("class","end-state-outer").attr("r",t().state.sizeUnit+t().state.miniPadding).attr("cx",t().state.padding+t().state.sizeUnit+t().state.miniPadding).attr("cy",t().state.padding+t().state.sizeUnit+t().state.miniPadding),e.append("circle").attr("class","end-state-inner").attr("r",t().state.sizeUnit).attr("cx",t().state.padding+t().state.sizeUnit+2).attr("cy",t().state.padding+t().state.sizeUnit+2)),D=(e,a)=>{let i=t().state.forkWidth,r=t().state.forkHeight;return a.parentId&&(a=i,i=r,r=a),e.append("rect").style("stroke","black").style("fill","black").attr("width",i).attr("height",r).attr("x",t().state.padding).attr("y",t().state.padding)},tt=(e,a,i,r)=>{let n=0;const d=r.append("text");d.style("text-anchor","start"),d.attr("class","noteText");let s=e.replace(/\r\n/g,"<br/>");r=(s=s.replace(/\n/g,"<br/>")).split(T.lineBreakRegex);let o=1.25*t().state.noteMargin;for(const p of r){var g=p.trim();if(0<g.length){const h=d.append("tspan");h.text(g),0===o&&(g=h.node().getBBox(),o+=g.height),n+=o,h.attr("x",a+t().state.noteMargin),h.attr("y",i+n+1.25*t().state.noteMargin)}}return{textWidth:d.node().getBBox().width,textHeight:n}},et=(e,a)=>{a.attr("class","state-note");const i=a.append("rect").attr("x",0).attr("y",t().state.padding),r=a.append("g"),{textWidth:n,textHeight:d}=tt(e,0,0,r);return i.attr("height",d+2*t().state.noteMargin),i.attr("width",n+2*t().state.noteMargin),i},G=function(e,a){const i=a.id,r={id:i,label:a.id,width:0,height:0},n=e.append("g").attr("id",i).attr("class","stateGroup");"start"===a.type&&j(n),"end"===a.type&&V(n),"fork"!==a.type&&"join"!==a.type||D(n,a),"note"===a.type&&et(a.note.text,n),"divider"===a.type&&q(n),"default"===a.type&&0===a.descriptions.length&&Z(n,a),"default"===a.type&&0<a.descriptions.length&&K(n,a);e=n.node().getBBox();return r.width=e.width+2*t().state.padding,r.height=e.height+2*t().state.padding,_.set(i,r),r};let A=0;const at=function(n,d,s){d.points=d.points.filter(t=>!Number.isNaN(t.y));const e=d.points,a=Y().x(function(t){return t.x}).y(function(t){return t.y}).curve(U),i=n.append("path").attr("d",a(e)).attr("id","edge"+A).attr("class","transition");let r="";if(t().state.arrowMarkerAbsolute&&(r=(r=(r=window.location.protocol+"//"+window.location.host+window.location.pathname+window.location.search).replace(/\(/g,"\\(")).replace(/\)/g,"\\)")),i.attr("marker-end","url("+r+"#"+function(t){switch(t){case N.relationType.AGGREGATION:return"aggregation";case N.relationType.EXTENSION:return"extension";case N.relationType.COMPOSITION:return"composition";case N.relationType.DEPENDENCY:return"dependency"}}(N.relationType.DEPENDENCY)+"End)"),void 0!==s.title){const o=n.append("g").attr("class","stateLabel"),{x:g,y:p}=F.calcLabelPosition(d.points),h=T.getRows(s.title);let a=0;const c=[];let e=0,i=0;for(let t=0;t<=h.length;t++){const l=o.append("text").attr("text-anchor","middle").text(h[t]).attr("x",g).attr("y",p+a),x=l.node().getBBox();e=Math.max(e,x.width),i=Math.min(i,x.x),b.info(x.x,g,p+a),0===a&&(a=l.node().getBBox().height,b.info("Title height",a,p)),c.push(l)}let r=a*h.length;if(1<h.length){const f=(h.length-1)*a*.5;c.forEach((t,e)=>t.attr("y",p+e*a-f)),r=a*h.length}n=o.node().getBBox();o.insert("rect",":first-child").attr("class","box").attr("x",g-e/2-t().state.padding/2).attr("y",p-r/2-t().state.padding/2-3.5).attr("width",e+t().state.padding).attr("height",r+t().state.padding),b.info(n)}A++};let B;const z={},it=function(){},nt=function(t){t.append("defs").append("marker").attr("id","dependencyEnd").attr("refX",19).attr("refY",7).attr("markerWidth",20).attr("markerHeight",28).attr("orient","auto").append("path").attr("d","M 19,7 L9,13 L14,7 L9,1 Z")},st=function(e,a,i,r){B=t().state;var n=t().securityLevel;let d;"sandbox"===n&&(d=H("#i"+a));const s=H("sandbox"===n?d.nodes()[0].contentDocument.body:"body"),o="sandbox"===n?d.nodes()[0].contentDocument:document,g=(b.debug("Rendering diagram "+e),s.select(`[id='${a}']`));nt(g);n=r.db.getRootDoc(),W(n,g,void 0,!1,s,o,r),e=B.padding,a=g.node().getBBox(),n=a.width+2*e,r=a.height+2*e;O(g,r,1.75*n,B.useMaxWidth),g.attr("viewBox",`${a.x-B.padding}  ${a.y-B.padding} `+n+" "+r)},rt=t=>t?t.length*B.fontSizeFactor:1,W=(t,a,i,r,n,d,s)=>{const o=new X({compound:!0,multigraph:!0});let e,g=!0;for(e=0;e<t.length;e++)if("relation"===t[e].stmt){g=!1;break}i?o.setGraph({rankdir:"LR",multigraph:!0,compound:!0,ranker:"tight-tree",ranksep:g?1:B.edgeLengthFactor,nodeSep:g?1:50,isMultiGraph:!0}):o.setGraph({rankdir:"TB",multigraph:!0,compound:!0,ranksep:g?1:B.edgeLengthFactor,nodeSep:g?1:50,ranker:"tight-tree",isMultiGraph:!0}),o.setDefaultEdgeLabel(function(){return{}}),s.db.extract(t);const p=s.db.getStates(),h=s.db.getRelations(),c=Object.keys(p);for(const w of c){const N=p[w];i&&(N.parentId=i);let e;if(N.doc){let t=a.append("g").attr("id",N.id).attr("class","stateGroup");e=W(N.doc,t,N.id,!r,n,d,s);var l=(t=Q(t,N,r)).node().getBBox();e.width=l.width,e.height=l.height+B.padding/2,z[N.id]={y:B.compositTitleSize}}else e=G(a,N);var x;N.note?(l={descriptions:[],id:N.id+"-note",note:N.note,type:"note"},x=G(a,l),"left of"===N.note.position?(o.setNode(e.id+"-note",x),o.setNode(e.id,e)):(o.setNode(e.id,e),o.setNode(e.id+"-note",x)),o.setParent(e.id,e.id+"-group"),o.setParent(e.id+"-note",e.id+"-group")):o.setNode(e.id,e)}b.debug("Count=",o.nodeCount(),o);let f=0;h.forEach(function(t){f++,b.debug("Setting edge",t),o.setEdge(t.id1,t.id2,{relation:t,width:rt(t.title),height:B.labelHeight*T.getRows(t.title).length,labelpos:"c"},"id"+f)}),J(o),b.debug("Graph after layout",o.nodes());const u=a.node();o.nodes().forEach(function(t){void 0!==t&&void 0!==o.node(t)?(b.warn("Node "+t+": "+JSON.stringify(o.node(t))),n.select("#"+u.id+" #"+t).attr("transform","translate("+(o.node(t).x-o.node(t).width/2)+","+(o.node(t).y+(z[t]?z[t].y:0)-o.node(t).height/2)+" )"),n.select("#"+u.id+" #"+t).attr("data-x-shift",o.node(t).x-o.node(t).width/2),d.querySelectorAll("#"+u.id+" #"+t+" .divider").forEach(t=>{const e=t.parentElement;let a=0,i=0;e&&(e.parentElement&&(a=e.parentElement.getBBox().width),i=parseInt(e.getAttribute("data-x-shift"),10),Number.isNaN(i)&&(i=0)),t.setAttribute("x1",0-i+8),t.setAttribute("x2",a-i-8)})):b.debug("No Node "+t+": "+JSON.stringify(o.node(t)))});var y;u.getBBox();o.edges().forEach(function(t){void 0!==t&&void 0!==o.edge(t)&&(b.debug("Edge "+t.v+" -> "+t.w+": "+JSON.stringify(o.edge(t))),at(a,o.edge(t),o.edge(t).relation))}),y=u.getBBox();const m={id:i||"root",label:i||"root",width:0,height:0};return m.width=y.width+2*B.padding,m.height=y.height+2*B.padding,b.debug("Doc rendered",m,o),m},ot={setConf:it,draw:st},xt={parser:C,db:N,renderer:ot,styles:R,init:t=>{t.state||(t.state={}),t.state.arrowMarkerAbsolute=t.arrowMarkerAbsolute,N.clear()}};export{xt as diagram};