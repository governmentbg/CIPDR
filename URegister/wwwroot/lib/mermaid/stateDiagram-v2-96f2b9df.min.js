import{D as DEFAULT_STATE_TYPE,a as DIVIDER_TYPE,S as STMT_RELATION,b as STMT_STATE,c as DEFAULT_NESTED_DOC_DIR,p as parser,d as db,s as styles}from"./styles-a1a6e33f.js";import*as graphlib from"dagre-d3-es/src/graphlib/index.js";import{select}from"d3";import{l as log,c as getConfig,u as utils,i as configureSvgSize,e as common}from"./mermaid-768dc893.js";import{r as render}from"./index-f58d48f9.js";import"ts-dedent";import"dayjs";import"@braintree/sanitize-url";import"dompurify";import"khroma";import"lodash-es/memoize.js";import"lodash-es/merge.js";import"stylis";import"lodash-es/isEmpty.js";import"dagre-d3-es/src/dagre/index.js";import"dagre-d3-es/src/graphlib/json.js";import"./edges-0005682e.js";import"./createText-3b1f58a4.js";import"mdast-util-from-markdown";import"./svgDraw-70101091.js";const SHAPE_STATE="rect",SHAPE_STATE_WITH_DESC="rectWithTitle",SHAPE_START="start",SHAPE_END="end",SHAPE_DIVIDER="divider",SHAPE_GROUP="roundedWithTitle",SHAPE_NOTE="note",SHAPE_NOTEGROUP="noteGroup",CSS_DIAGRAM="statediagram",CSS_STATE="state",CSS_DIAGRAM_STATE=CSS_DIAGRAM+"-"+CSS_STATE,CSS_EDGE="transition",CSS_NOTE="note",CSS_NOTE_EDGE="note-edge",CSS_EDGE_NOTE_EDGE=CSS_EDGE+" "+CSS_NOTE_EDGE,CSS_DIAGRAM_NOTE=CSS_DIAGRAM+"-"+CSS_NOTE,CSS_CLUSTER="cluster",CSS_DIAGRAM_CLUSTER=CSS_DIAGRAM+"-"+CSS_CLUSTER,CSS_CLUSTER_ALT="cluster-alt",CSS_DIAGRAM_CLUSTER_ALT=CSS_DIAGRAM+"-"+CSS_CLUSTER_ALT,PARENT="parent",NOTE="note",DOMID_STATE="state",DOMID_TYPE_SPACER="----",NOTE_ID=""+DOMID_TYPE_SPACER+NOTE,PARENT_ID=""+DOMID_TYPE_SPACER+PARENT,G_EDGE_STYLE="fill:none",G_EDGE_ARROWHEADSTYLE="fill: #333",G_EDGE_LABELPOS="c",G_EDGE_LABELTYPE="text",G_EDGE_THICKNESS="normal";let nodeDb={},graphItemCount=0;const setConf=function(e){for(const t of Object.keys(e))e[t]},getClasses=function(e,t){return t.db.extract(t.db.getRootDocV2()),t.db.getClasses()};function getClassesFromDbInfo(e){return null!=e&&e.classes?e.classes.join(" "):""}function stateDomId(e="",t=0,s="",o=DOMID_TYPE_SPACER){o=null!==s&&0<s.length?""+o+s:"";return DOMID_STATE+`-${e}${o}-`+t}const setupNode=(s,e,o,t,r,a)=>{var i=o.id,E=getClassesFromDbInfo(t[i]);if("root"!==i){let e=SHAPE_STATE;!0===o.start&&(e=SHAPE_START),!1===o.start&&(e=SHAPE_END),o.type!==DEFAULT_STATE_TYPE&&(e=o.type),nodeDb[i]||(nodeDb[i]={id:i,shape:e,description:common.sanitizeText(i,getConfig()),classes:E+" "+CSS_DIAGRAM_STATE});const S=nodeDb[i],_=(o.description&&(Array.isArray(S.description)?(S.shape=SHAPE_STATE_WITH_DESC,S.description.push(o.description)):0<S.description.length?(S.shape=SHAPE_STATE_WITH_DESC,S.description===i?S.description=[o.description]:S.description=[S.description,o.description]):(S.shape=SHAPE_STATE,S.description=o.description),S.description=common.sanitizeTextOrArray(S.description,getConfig())),1===S.description.length&&S.shape===SHAPE_STATE_WITH_DESC&&(S.shape=SHAPE_STATE),!S.type&&o.doc&&(log.info("Setting cluster for ",i,getDir(o)),S.type="group",S.dir=getDir(o),S.shape=o.type===DIVIDER_TYPE?SHAPE_DIVIDER:SHAPE_GROUP,S.classes=S.classes+" "+CSS_DIAGRAM_CLUSTER+" "+(a?CSS_DIAGRAM_CLUSTER_ALT:"")),{labelStyle:"",shape:S.shape,labelText:S.description,classes:S.classes,style:"",id:i,dir:S.dir,domId:stateDomId(i,graphItemCount),type:S.type,padding:15});if(_.centerLabel=!0,o.note){var E={labelStyle:"",shape:SHAPE_NOTE,labelText:o.note.text,classes:CSS_DIAGRAM_NOTE,style:"",id:i+NOTE_ID+"-"+graphItemCount,domId:stateDomId(i,graphItemCount,NOTE),type:S.type,padding:15},d={labelStyle:"",shape:SHAPE_NOTEGROUP,labelText:o.note.text,classes:S.classes,style:"",id:i+PARENT_ID,domId:stateDomId(i,graphItemCount,PARENT),type:"group",padding:0},n=(graphItemCount++,i+PARENT_ID);s.setNode(n,d),s.setNode(E.id,E),s.setNode(i,_),s.setParent(i,n),s.setParent(E.id,n);let e=i,t=E.id;"left of"===o.note.position&&(e=E.id,t=i),s.setEdge(e,t,{arrowhead:"none",arrowType:"",style:G_EDGE_STYLE,labelStyle:"",classes:CSS_EDGE_NOTE_EDGE,arrowheadStyle:G_EDGE_ARROWHEADSTYLE,labelpos:G_EDGE_LABELPOS,labelType:G_EDGE_LABELTYPE,thickness:G_EDGE_THICKNESS})}else s.setNode(i,_)}e&&"root"!==e.id&&(log.trace("Setting node ",i," to be child of its parent ",e.id),s.setParent(i,e.id)),o.doc&&(log.trace("Adding nodes children "),setupDoc(s,o,o.doc,t,r,!a))},setupDoc=(s,o,e,r,a,i)=>{log.trace("items",e),e.forEach(e=>{switch(e.stmt){case STMT_STATE:case DEFAULT_STATE_TYPE:setupNode(s,o,e,r,a,i);break;case STMT_RELATION:setupNode(s,o,e.state1,r,a,i),setupNode(s,o,e.state2,r,a,i);var t={id:"edge"+graphItemCount,arrowhead:"normal",arrowTypeEnd:"arrow_barb",style:G_EDGE_STYLE,labelStyle:"",label:common.sanitizeText(e.description,getConfig()),arrowheadStyle:G_EDGE_ARROWHEADSTYLE,labelpos:G_EDGE_LABELPOS,labelType:G_EDGE_LABELTYPE,thickness:G_EDGE_THICKNESS,classes:CSS_EDGE};s.setEdge(e.state1.id,e.state2.id,t,graphItemCount),graphItemCount++}})},getDir=(t,e=DEFAULT_NESTED_DOC_DIR)=>{let s=e;if(t.doc)for(let e=0;e<t.doc.length;e++){var o=t.doc[e];"dir"===o.stmt&&(s=o.value)}return s},draw=async function(e,t,s,o){log.info("Drawing state diagram (v2)",t),nodeDb={},o.db.getDirection();var{securityLevel:r,state:a}=getConfig(),i=a.nodeSpacing||50,E=a.rankSpacing||50,d=(log.info(o.db.getRootDocV2()),o.db.extract(o.db.getRootDocV2()),log.info(o.db.getRootDocV2()),o.db.getStates()),i=new graphlib.Graph({multigraph:!0,compound:!0}).setGraph({rankdir:getDir(o.db.getRootDocV2()),nodesep:i,ranksep:E,marginx:8,marginy:8}).setDefaultEdgeLabel(function(){return{}});setupNode(i,void 0,o.db.getRootDocV2(),d,o.db,!0);let n;"sandbox"===r&&(n=select("#i"+t));const S=select("sandbox"===r?n.nodes()[0].contentDocument.body:"body"),_=S.select(`[id="${t}"]`);E=S.select("#"+t+" g"),await render(E,i,["barb"],CSS_DIAGRAM,t),utils.insertTitle(_,"statediagramTitleText",a.titleTopMargin,o.db.getDiagramTitle()),d=_.node().getBBox(),r=d.width+16,E=d.height+16,_.attr("class",CSS_DIAGRAM),i=_.node().getBBox(),configureSvgSize(_,E,r,a.useMaxWidth),o=`${i.x-8} ${i.y-8} ${r} `+E,log.debug("viewBox "+o),_.attr("viewBox",o),d=document.querySelectorAll('[id="'+t+'"] .edgeLabel .label');for(const T of d){var l=T.getBBox();const A=document.createElementNS("http://www.w3.org/2000/svg",SHAPE_STATE);A.setAttribute("rx",0),A.setAttribute("ry",0),A.setAttribute("width",l.width),A.setAttribute("height",l.height),T.insertBefore(A,T.firstChild)}},renderer={setConf:setConf,getClasses:getClasses,draw:draw},diagram={parser:parser,db:db,renderer:renderer,styles:styles,init:e=>{e.state||(e.state={}),e.state.arrowMarkerAbsolute=e.arrowMarkerAbsolute,db.clear()}};export{diagram};